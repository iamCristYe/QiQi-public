name: Scheduled Scraper Trigger

on:
  schedule:
    - cron: '30 2-22/4 * * *'
  workflow_dispatch:

jobs:
  trigger:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout public repo
      uses: actions/checkout@v4

    - name: Poll for condition and run task
      run: |
            #!/bin/bash
            while true; do
              current_hour=$(date +%H)
              if (( 10#$current_hour % 4 == 0 )); then
                break
              fi
              sleep 50
            done
            echo "Condition met! Task executed at $(date '+%Y-%m-%d %H:%M:%S')"
            
            # Loop 4 times: Optional quick check, trigger scraper-runner workflow, sleep 1 hour
            for i in {1..4}; do
              echo "Loop iteration $i/4 at $(date '+%Y-%m-%d %H:%M:%S')"
              
              # Optional: Add a quick Python check here if needed (e.g., echo "Pre-trigger check")
              echo "Pre-trigger check complete."
              
              # Trigger the scraper-runner workflow
              curl -X POST \
                -H "Authorization: Bearer ${{ secrets.PAT_GITHUB }}" \
                -H "Accept: application/vnd.github.v3+json" \
                https://api.github.com/repos/iamCristYe/QiQi-public/actions/workflows/runner.yml/dispatches \
                -d '{"ref":"main"}'
              
              echo "Triggered scraper-runner workflow. Sleeping 3600s..."
              sleep 3600
            done
            
            echo "Hourly loop completed."